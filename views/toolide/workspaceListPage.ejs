<% include ../header.ejs %>
<section id="workspaceList">
</section>
<!-- localNav -->
<div class="mypageNavbar-header">
    <div class="container wrapper">
        <div class="header__paragraph">
            <div class="header__paragraph-1">
                <span class="header__label-my"><%=language.toolide.title%></span><span class="header__label-ide"><%=language.toolide.title2%></span>
            </div>
            <div class="header__paragraph-2">
                <span class="header__divider"></span><span class="header__label-usage"><%=language.toolide.subTitle%></span>
            </div>
        </div>
        <!-- <img class="header__logo" src="/public/img/logo.png"> -->
    </div>
</div>

<div class="mypageNav"> 
    <div class="container wrapper">
        <div class="tab__eiditUser active">
            <%=language.toolide.subtitle2%>
        </div>
    </div>
</div>



<!-- content -->
<div class="container" id="workspaceListPage">
    <div class="row">
        
        <!-- 워크스페이스를 처음 생성 하는 경우 -->
        <% if ( workspace == "" || workspace == null || workspace == undefined || ( workspace != null && typeof workspace == "object" && !Object.keys(workspace).length)) {%>
            <div class ="col-lg-4 col-md-6 mb-4 create">
                <div class="card-body"><img class="logo" src="/public/img/workspace.png">
                    <p>Demo.ver Workspace</p>
                </div>
                <div class="card-footer">
                    <a href="#" class="button" onclick="createWorkspace();"><%=language.toolide.createWorkspace%></a>
                </div>
            </div>
        
        <!-- 워크스페이스가 이미 생성되어져 있는 경우-->
        <% } else {%>
            <div class ="col-lg-4 col-md-6 mb-4 create">
                <div class="card-body"><img class="logo" src="/public/img/workspace.png">
                    <span id="content"></span>
                </div>
                <!-- <div class="card-footer">
                    <a href="#" class="button" onclick="alert('Demo ver의 워크스페이스는 최대 1개만 생성 가능합니다. 삭제 후 시도해 주세요.')">Create Workspace</a>
                </div> -->
            </div>
        <% } %>

        <!-- 생성된 워크스페이스 리스트 -->
        <% workspace.forEach( function(data) { %>
        <div class ="col-lg-4 col-md-6 mb-4" id="vm-panel_new"> 
            <div class="row" id="vm_header">
                <div id="vm_updated">
                    <i class="fa fa-calendar-check-o" aria-hidden="true"></i>
                    <span>Create Date : <%=data.getDate.year%> - 
                        <%=data.getDate.month%> -  
                        <%=data.getDate.day%> </span>
                </div>
                <a id="vm_moreview">
                    <i class="fa fa-bolt" aria-hidden="true"></i>
                    <span>Demo ver</span>
                </a>
            </div>
            <div id="vm_body">
                <div id="vm_project_name">
                    <span class="workspace_title"><%=language.toolide.workspaceName%></span>
                    <span class="workspace_name"><%= data.stackname %></span>
                </div>
                <div class="row">
                    <div class="col-xs-5 vm_label"> User ID</div>
                    <div class="col-xs-7 vm_content"> <%= data.userid %> </div>
                </div>

            </div>
            <div class="row" id="vm_footer">
                <a id="vm_btn_run" href="<%=data.ide_url %>" target="_blank"><t><%=language.toolide.run%></t></a>
                <a id="vm_btn_run_terminal" onclick="deleteWorkspace('<%=data.stackname %>')"><t><%=language.toolide.remove%></t></a>
            </div>
        </div>
        <% }); %>
    </div>
    <!-- <div class="col-md-4 col-md-offset-4">       
        내 워크스페이스 리스트 <br><br>
        <div class="container">
            <button class="btn btn-primary" onclick="location.href='/toolide/createWorkspacePage'">워크스페이스 생성</button>
        </div>
        <br><br>
       <br>
        <% workspace.forEach(function(workspace){ %>
            <%=workspace.userid%> <br>            
            <a href="<%=workspace.ide_elb_dns%>" target="_blank"><%=workspace.stackname%> 워크스페이스 실행</a>
            <button class="btn btn-link"  onclick="deleteWorkspace('<%=workspace.stackname%>')">워크스페이스 삭제</button>
        <% }); %>    
    </div> -->

       

</div>






<script type="text/javascript">
    $(document).ready(function(){
        // <> 치환을 위해 변형 후 해당 태그에 값을 넣어준다.
        var value = "<%=language.toolide.demoverMessage%>";
        var str = value.replace(/&lt;/g, '<').replace(/&gt;/g, '>') ;
        $("#content").html(str);
    });



/**
 * Module for displaying "Waiting for..." dialog using Bootstrap
 *
 * @author Eugene Maslovich <ehpc@em42.ru>
 */

var waitingDialog = waitingDialog || (function ($) {
    'use strict';

	// Creating modal dialog's DOM
	var $dialog = $(
		'<div class="modal fade" data-backdrop="static" data-keyboard="false" tabindex="-1" role="dialog" aria-hidden="true" style="padding-top:15%; overflow-y:visible;">' +
		'<div class="modal-dialog modal-m">' +
		'<div class="modal-content">' +
            '<div class="modal-header"><h3 style="margin:0;"></h3></div>' +
			'<div class="modal-body">' +
				'<div class="progress progress-striped active" style="margin-bottom:0;"><div class="progress-bar" style="width: 100%"></div></div>' +
			'</div>' +
		'</div></div></div>');

	return {
		/**
		 * Opens our dialog
		 * @param message Custom message
		 * @param options Custom options:
		 * 				  options.dialogSize - bootstrap postfix for dialog size, e.g. "sm", "m";
		 * 				  options.progressType - bootstrap postfix for progress bar type, e.g. "success", "warning".
		 */
		show: function (message, options) {
			// Assigning defaults
			if (typeof options === 'undefined') {
				options = {};
			}
			if (typeof message === 'undefined') {
				message = '<%=language.toolide.loading%>';
			}
			var settings = $.extend({
				dialogSize: 'm',
				progressType: '',
				onHide: null // This callback runs after the dialog was hidden
			}, options);

			// Configuring dialog
			$dialog.find('.modal-dialog').attr('class', 'modal-dialog').addClass('modal-' + settings.dialogSize);
			$dialog.find('.progress-bar').attr('class', 'progress-bar');
			if (settings.progressType) {
				$dialog.find('.progress-bar').addClass('progress-bar-' + settings.progressType);
			}
			$dialog.find('h3').text(message);
			// Adding callbacks
			if (typeof settings.onHide === 'function') {
				$dialog.off('hidden.bs.modal').on('hidden.bs.modal', function (e) {
					settings.onHide.call($dialog);
				});
			}
			// Opening dialog
			$dialog.modal();
		},
		/**
		 * Closes dialog
		 */
		hide: function () {
			$dialog.modal('hide');
		}
	};
})(jQuery);

function deleteWorkspace(stackname) {    
    if(confirm(stackname + "<%=language.toolide.confirmRemove%>")==true){
        $.get("/toolide/deleteWorkspace", {stackname:stackname}, function(args) {
            if(args == "error") {
                alert("<%=language.toolide.failRemove%>");
                location.href = "/toolide/workspaceList";
            } else {
                //alert("워크스페이스 삭제를 잠시 기다려 주세요.");
                waitingDialog.show();
                $.get("/toolide/waitForStackDeleteComplete", {args:args}, function(args2) {
                    if(args2 == "sent") {
                        waitingDialog.hide();
                        alert("<%=language.toolide.successRemove%>");
                        location.href = "/toolide/workspaceList";
                    } 
                });
            }
        });
    } else {
        return;
    }           
}

function createWorkspace() {
    $.get("/toolide/createWorkspace/", function(args) {
        if(args == "error"){
            alert("<%=language.toolide.failCreateWorkspace%>");
            location.href = "/toolide/workspaceList";
        }else {
            waitingDialog.show();
            myVar = setInterval(function() {
            myTimer(args)
            }, 36000);
        }
    })
}

function myTimer(args) {
    $.get("/toolide/checkStackCreateComplete", {args:args}, function(args2) {
        if(args2 == "CREATE_IN_PROGRESS") {            
            console.log("생성중");
        } else if (args2 == "CREATE_COMPLETE") {
            console.log("상태 체크중");
        } else if  (args2 == "initializing"){
            console.log("상태 체크중");
        } else if(args2 == "ok") {
            stopInterval();
            waitingDialog.hide();
            alert("Creation completed.");
            location.href = "/toolide/workspaceList";        
        } else if (args2 == "ROLLBACK_IN_PROGRESS", "ROLLBACK_COMPLETE") {
            stopInterval();
            $.get("/toolide/deleteRollbackWorkspace", {args:args}, function(err, args3) {
                if(args3) {
                    alert("Failed to create workspace! please try agian.");
                    location.href = "/toolide/workspaceList";  
                } 
            });
        }
    });    
}

function stopInterval() {
    clearInterval(myVar);
}


</script>

<% include ../footer.ejs %>